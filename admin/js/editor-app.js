(()=>{const{useState:e,useEffect:l,createElement:t}=wp.element,{Button:a,TextControl:n,Panel:i,PanelBody:o,SelectControl:r,TabPanel:s}=wp.components,u=[{label:"Text Input",value:"text"},{label:"Number Input",value:"number"},{label:"Range Slider",value:"range"},{label:"URL Link",value:"url"},{label:"Text Area",value:"textarea"},{label:"Rich Text Content",value:"contentEditor"},{label:"Image/Media",value:"image"},{label:"File Upload",value:"file"},{label:"Gallery",value:"gallery"},{label:"Date Picker",value:"date"},{label:"Date Time Picker",value:"datetime"},{label:"Time Picker",value:"time"},{label:"Color Picker",value:"color"},{label:"Icon Picker",value:"icon"},{label:"Repeater/Group",value:"repeater"},{label:"Relational (Post Select)",value:"relational"}],d=e=>e.toLowerCase().replace(/[^a-z0-9_]/g,""),p=({initialConfig:l,blockSlug:p})=>{const[c,b]=e(l.fields||[]),[g,y]=e(!1),[f,m]=e(null),[v,h]=e(""),[x,k]=e(l.template||""),[S,C]=e(l.css||""),[T,F]=e(null),[w,D]=e(null),_=(e,l,t)=>{const a=c.map((a,n)=>n===e?("key"===l&&(t=t.toLowerCase().replace(/[^a-z0-9_]/g,"")),{...a,[l]:t}):a);b(a),m(a[e])},[E,P]=e(null),$=(e,l,i,s)=>{const p=e.subFields||[],c=(e,t,a)=>{const n=p.map((l,n)=>n===e?("key"===t&&(a=d(a)),{...l,[t]:a}):l);i(l,"subFields",n)};return t(o,{title:"Repeater Sub-Fields",initialOpen:!0},t("h4",null,"Add New Sub-Field"),t("div",{style:{display:"flex",flexWrap:"wrap",gap:"5px",marginBottom:"15px"}},u.filter(e=>"repeater"!==e.value&&"relational"!==e.value).map(e=>t(a,{isSecondary:!0,onClick:()=>(e=>{const t={type:e,key:d(`sub_field_${p.length}_${e}`),label:`New ${e} Sub-Field`,default:""};i(l,"subFields",[...p,t])})(e.value)},e.label))),t("h4",null,`Current Sub-Fields (${p.length})`),p.length>0?p.map((e,s)=>((e,s)=>t("div",{key:s,draggable:!0,onDragStart:e=>((e,l)=>{e.stopPropagation(),D(l),e.dataTransfer.effectAllowed="move"})(e,s),onDragOver:e=>e.preventDefault(),onDragEnter:e=>((e,t)=>{if(e.stopPropagation(),null===w||w===t)return;const a=[...p],n=a[w];a.splice(w,1),a.splice(t,0,n),i(l,"subFields",a),D(t)})(e,s),onDrop:e=>(e=>{e.preventDefault(),e.stopPropagation(),D(null)})(e),style:{marginTop:"10px",opacity:w===s?.5:1,transition:"opacity 0.2s",cursor:"grab"}},t(o,{title:`${e.label} (${e.type})`,initialOpen:!1,className:"repeater-sub-field-settings"},t(n,{label:"Sub-Field Label",value:e.label,onChange:e=>c(s,"label",e)}),t(n,{label:"Attribute Key (Variable Name)",value:e.key,help:"Must be unique, lowercase, and contain only letters, numbers, and underscores.",onChange:e=>c(s,"key",e)}),t(r,{label:"Sub-Field Type",value:e.type,options:u.map(e=>({label:e.label,value:e.value})).filter(e=>"repeater"!==e.value),onChange:e=>c(s,"type",e)}),t(a,{isDestructive:!0,onClick:()=>(e=>{const t=p.filter((l,t)=>t!==e);i(l,"subFields",t)})(s),style:{marginTop:"10px"}},"Delete Sub-Field"))))(e,s)):t("p",null,"No sub-fields defined. Add one above."))};return t("div",{style:{display:"flex",gap:"20px",marginTop:"20px"}},t("div",{style:{width:"20%",borderRight:"1px solid #ccc",paddingRight:"20px"}},t("h3",null,"Component Palette"),u.map(e=>t(a,{isSecondary:!0,style:{display:"block",width:"100%",marginBottom:"10px"},onClick:()=>(e=>{const l={type:e,key:`new_field_${c.length}`,label:`New ${e} Field`,default:""};b([...c,l]),m(l)})(e.value)},e.label))),t("div",{style:{width:"40%"}},t(s,{className:"bf-editor-tabs",activeClass:"is-active-tab",tabs:[{name:"structure",title:"1. Structure",className:"bf-tab-structure"},{name:"template",title:"2. Template & Style",className:"bf-tab-template"}]},e=>"structure"===e.name?t("div",{style:{marginTop:"20px"}},t("h3",null,"Block Fields"),c.map((e,l)=>t("div",{key:l,draggable:!0,onDragStart:e=>((e,l)=>{F(l),e.dataTransfer.effectAllowed="move"})(e,l),onDragOver:e=>(e=>{e.preventDefault()})(e),onDragEnter:e=>((e,l)=>{if(null===T||T===l)return;const t=[...c],a=t[T];t.splice(T,1),t.splice(l,0,a),b(t),F(l)})(0,l),onDrop:e=>(e=>{e.preventDefault(),F(null)})(e),style:{padding:"10px",marginBottom:"8px",border:"1px solid #ddd",backgroundColor:f===e?"#eaf4ff":T===l?"#f0f0f0":"#fff",opacity:T===l?.5:1,cursor:"grab",display:"flex",justifyContent:"space-between",transition:"background-color 0.2s, opacity 0.2s"},onClick:()=>m(e)},t("div",{style:{display:"flex",alignItems:"center",gap:"8px"}},t("span",{style:{cursor:"grab",color:"#999",fontSize:"18px"}},"⋮⋮"),t("span",null,`${e.label} (${e.type})`)),t(a,{isSmall:!0,isTertiary:!0,onClick:l=>{l.stopPropagation(),(e=>{const l=document.getElementById("bf-html-template-area"),t=l.selectionStart,a=l.selectionEnd,n=l.value,i=`{{${e}}}`,o=n.substring(0,t)+i+n.substring(a);k(o),setTimeout(()=>{l.focus(),l.setSelectionRange(t+i.length,t+i.length)},10)})(e.key)}},"Add to HTML"))),0===c.length&&t("p",{style:{fontStyle:"italic",color:"#777"}},"No fields yet. Add one from the Component Palette.")):"template"===e.name?t("div",{style:{marginTop:"20px"}},E&&t(o,{title:"Template Snippets (Cheat Sheet)",initialOpen:!0,style:{marginBottom:"20px",background:"#f8f9fa",border:"1px solid #ddd"}},t("div",{dangerouslySetInnerHTML:{__html:E},style:{fontSize:"12px",lineHeight:"1.5",maxHeight:"200px",overflowY:"auto"}})),t("h3",null,"HTML Template"),t("p",{style:{fontSize:"12px",color:"#666"}},'Write your HTML below. Click the "Add to HTML" buttons in the Structure tab to insert keys.'),t("textarea",{id:"bf-html-template-area",value:x,onChange:e=>k(e.target.value),style:{width:"100%",minHeight:"250px",fontFamily:"monospace",padding:"12px",fontSize:"13px",border:"1px solid #757575",borderRadius:"4px"},placeholder:`<div class="banner">\n  <h2>{{${c[0]?.key||"field_key"}}}</h2>\n</div>`}),t("hr",{style:{margin:"20px 0"}}),t("h3",null,"CSS Styles"),t("textarea",{value:S,onChange:e=>C(e.target.value),style:{width:"100%",minHeight:"150px",fontFamily:"monospace",padding:"12px",fontSize:"13px",border:"1px solid #757575",borderRadius:"4px"},placeholder:".bf-block-example {\n  background: #f0f0f0;\n  padding: 20px;\n}"})):void 0),t("hr",null),t(a,{isPrimary:!0,isBusy:g,onClick:()=>(()=>{y(!0),h("Saving structure..."),P(null);const e={action:"block_factory_save_structure",nonce:blockFactoryEditor.nonce,block_slug:p,config_data:JSON.stringify({fields:c,template:x,css:S})};jQuery.post(ajaxurl,e).done(e=>{e.success?(h("✅ Structure saved! Starting build..."),e.data.cheat_sheet&&P(e.data.cheat_sheet),jQuery.post(ajaxurl,{action:"bf_run_npm_build",nonce:blockFactoryEditor.nonce}).done(e=>{e.success?h("✅ Build Complete! Your block is ready."):h(`⚠️ Build Failed. Error Details:\n${e.output}`)}).fail(()=>{h("⚠️ Save success, but Build request failed.")}).always(()=>{y(!1)})):(h(`❌ Error: ${e.data.message}`),y(!1))}).fail(()=>{h("❌ Critical Error: Could not reach the server."),y(!1)})})(),disabled:g,style:{marginTop:"20px"}},g?"Compiling Code...":"Save Structure & Build Block"),v&&t("p",{style:{marginTop:"15px",fontWeight:"bold"}},v)),t("div",{style:{width:"40%"}},(()=>{if(!f)return t("p",null," Select a field on the left to edit its properties. ");const e=c.indexOf(f);return t(i,{header:"Field Settings"}," "," ",t(o,{title:`Editing: ${f.label} (${f.type})`,initialOpen:!0},t(n,{label:"Field Label",value:f.label,onChange:l=>_(e,"label",l)})," ",t(n,{label:"Attribute Key (Variable Name)",value:f.key,help:"Must be unique, lowercase, and contain only letters, numbers, and underscores.",onChange:l=>_(e,"key",l)})," ",t(n,{label:"Default Value (Optional)",value:f.default,onChange:l=>_(e,"default",l)})," ",t(a,{isDestructive:!0,onClick:()=>(e=>{b(c.filter((l,t)=>t!==e)),m(null)})(e),style:{marginTop:"10px"}},"Delete Field ")," ")," ","repeater"===f.type&&$(f,e,_)," ")})()))};jQuery(document).ready(function(){const e=document.getElementById("component-editor-root");e&&"undefined"!=typeof blockFactoryEditor&&wp.element.render(t(p,{initialConfig:blockFactoryEditor.config,blockSlug:blockFactoryEditor.blockSlug}),e)})})();