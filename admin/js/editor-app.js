(()=>{const{useState:e,useEffect:l,createElement:t}=wp.element,{Button:a,TextControl:i,Panel:n,PanelBody:o,SelectControl:r,TabPanel:d}=wp.components,s=[{label:"Text Input",value:"text"},{label:"Number Input",value:"number"},{label:"Range Slider",value:"range"},{label:"URL Link",value:"url"},{label:"Text Area",value:"textarea"},{label:"Rich Text Content",value:"contentEditor"},{label:"Image/Media",value:"image"},{label:"File Upload",value:"file"},{label:"Gallery",value:"gallery"},{label:"Date Picker",value:"date"},{label:"Date Time Picker",value:"datetime"},{label:"Time Picker",value:"time"},{label:"Color Picker",value:"color"},{label:"Icon Picker",value:"icon"},{label:"Repeater/Group",value:"repeater"},{label:"Relational (Post Select)",value:"relational"}],p=e=>e.toLowerCase().replace(/[^a-z0-9_]/g,""),u=({initialConfig:l,blockSlug:d})=>{const[u,c]=e(l.fields||[]),[b,y]=e(!1),[g,f]=e(null),[m,v]=e(""),[x,h]=e(l.template||""),[k,S]=e(l.css||""),[C,w]=e(0),[F,T]=e(null),[D,B]=e(null),_=(e,l,t)=>{const a=u.map((a,i)=>i===e?("key"===l&&(t=t.toLowerCase().replace(/[^a-z0-9_]/g,"")),{...a,[l]:t}):a);c(a),f(a[e])},[E,P]=e(null),$=(e=!1,l=null)=>{y(!0),v(e?"Saving & Building...":"Saving Structure..."),P(null);const t={action:"block_factory_save_structure",nonce:blockFactoryEditor.nonce,block_slug:d,config_data:JSON.stringify({fields:u,template:x,css:k})};jQuery.post(ajaxurl,t).done(t=>{t.success?(t.data.cheat_sheet&&P(t.data.cheat_sheet),e?(v("✅ Saved! Starting build..."),jQuery.post(ajaxurl,{action:"bf_run_npm_build",nonce:blockFactoryEditor.nonce}).done(e=>{e.success?v("✅ Build Complete! Your block is ready."):v(`⚠️ Build Failed. Error Details:\n${e.output}`)}).fail(()=>{v("⚠️ Save success, but Build request failed.")}).always(()=>{y(!1)})):(v("✅ Structure Saved."),y(!1),null!==l&&w(l))):(v(`❌ Error: ${t.data.message}`),y(!1))}).fail(()=>{v("❌ Critical Error: Could not reach the server."),y(!1)})},N=(e,l,n,d)=>{const u=e.subFields||[],c=(e,t,a)=>{const i=u.map((l,i)=>i===e?("key"===t&&(a=p(a)),{...l,[t]:a}):l);n(l,"subFields",i)};return t(o,{title:"Repeater Sub-Fields",initialOpen:!0},t("h4",null,"Add New Sub-Field"),t("div",{style:{display:"flex",flexWrap:"wrap",gap:"5px",marginBottom:"15px"}},s.filter(e=>"repeater"!==e.value&&"relational"!==e.value).map(e=>t(a,{isSecondary:!0,onClick:()=>(e=>{const t={type:e,key:p(`sub_field_${u.length}_${e}`),label:`New ${e} Sub-Field`,default:""};n(l,"subFields",[...u,t])})(e.value)},e.label))),t("h4",null,`Current Sub-Fields (${u.length})`),u.length>0?u.map((e,d)=>((e,d)=>t("div",{key:d,draggable:!0,onDragStart:e=>((e,l)=>{e.stopPropagation(),B(l),e.dataTransfer.effectAllowed="move"})(e,d),onDragOver:e=>e.preventDefault(),onDragEnter:e=>((e,t)=>{if(e.stopPropagation(),null===D||D===t)return;const a=[...u],i=a[D];a.splice(D,1),a.splice(t,0,i),n(l,"subFields",a),B(t)})(e,d),onDrop:e=>(e=>{e.preventDefault(),e.stopPropagation(),B(null)})(e),style:{marginTop:"10px",opacity:D===d?.5:1,transition:"opacity 0.2s",cursor:"grab"}},t(o,{title:`${e.label} (${e.type})`,initialOpen:!1,className:"repeater-sub-field-settings"},t(i,{label:"Sub-Field Label",value:e.label,onChange:e=>c(d,"label",e)}),t(i,{label:"Attribute Key (Variable Name)",value:e.key,help:"Must be unique, lowercase, and contain only letters, numbers, and underscores.",onChange:e=>c(d,"key",e)}),t(r,{label:"Sub-Field Type",value:e.type,options:s.map(e=>({label:e.label,value:e.value})).filter(e=>"repeater"!==e.value),onChange:e=>c(d,"type",e)}),t(a,{isDestructive:!0,onClick:()=>(e=>{const t=u.filter((l,t)=>t!==e);n(l,"subFields",t)})(d),style:{marginTop:"10px"}},"Delete Sub-Field"))))(e,d)):t("p",null,"No sub-fields defined. Add one above."))};return 0===C?t("div",{style:{marginTop:"20px"}},t("div",{style:{marginBottom:"20px",padding:"10px",background:"#e5e5e5",display:"flex",justifyContent:"space-between",alignItems:"center"}},t("h2",{style:{margin:0}},"Step 1: Define Block Structure"),t("div",null,t(a,{isPrimary:!0,isBusy:b,onClick:()=>$(!1,1)},"Next: Edit Template >"))),t("div",{style:{display:"flex",gap:"20px"}},t("div",{style:{width:"20%",borderRight:"1px solid #ccc",paddingRight:"20px"}},t("h3",null,"Add Fields"),s.map(e=>t(a,{isSecondary:!0,style:{display:"block",width:"100%",marginBottom:"10px"},onClick:()=>(e=>{const l={type:e,key:`new_field_${u.length}`,label:`New ${e} Field`,default:""};c([...u,l]),f(l)})(e.value)},e.label))),t("div",{style:{width:"40%"}},t("h3",null,"Block Fields"),0===u.length&&t("p",{style:{fontStyle:"italic",color:"#777"}},"No fields added. Click a field type on the left to begin."),u.map((e,l)=>t("div",{key:l,draggable:!0,onDragStart:e=>((e,l)=>{T(l),e.dataTransfer.effectAllowed="move"})(e,l),onDragOver:e=>(e=>{e.preventDefault()})(e),onDragEnter:e=>((e,l)=>{if(null===F||F===l)return;const t=[...u],a=t[F];t.splice(F,1),t.splice(l,0,a),c(t),T(l)})(0,l),onDrop:e=>(e=>{e.preventDefault(),T(null)})(e),style:{padding:"10px",marginBottom:"8px",border:"1px solid #ddd",backgroundColor:g===e?"#eaf4ff":F===l?"#f0f0f0":"#fff",opacity:F===l?.5:1,cursor:"grab",display:"flex",justifyContent:"space-between",alignItems:"center",transition:"all 0.2s",borderLeft:g===e?"4px solid #007cba":"1px solid #ddd"},onClick:()=>f(e)},t("div",{style:{display:"flex",alignItems:"center",gap:"8px"}},t("span",{style:{cursor:"grab",color:"#ccc",fontSize:"18px"}},"⋮⋮"),t("span",{style:{fontWeight:"500"}},e.label),t("span",{style:{color:"#666",fontSize:"0.9em"}},`(${e.type})`)),t("span",{style:{color:"#007cba",fontSize:"20px"}},"›")))),t("div",{style:{width:"40%"}},(()=>{if(!g)return t("p",{style:{padding:"20px",color:"#666",fontStyle:"italic",border:"1px dashed #ccc",marginTop:"20px"}},"Select a field on the left to edit its settings.");const e=u.indexOf(g);return t(n,{header:"Field Settings"},t(o,{title:`Editing: ${g.label} (${g.type})`,initialOpen:!0},t(i,{label:"Field Label",value:g.label,onChange:l=>_(e,"label",l)}),t(i,{label:"Attribute Key (Variable Name)",value:g.key,help:"Must be unique, lowercase, and contain only letters, numbers, and underscores.",onChange:l=>_(e,"key",l)}),t(i,{label:"Default Value (Optional)",value:g.default,onChange:l=>_(e,"default",l)}),t(a,{isDestructive:!0,onClick:()=>(e=>{c(u.filter((l,t)=>t!==e)),f(null)})(e),style:{marginTop:"10px"}},"Delete Field")),"repeater"===g.type&&N(g,e,_))})()))):1===C?t("div",{style:{marginTop:"20px"}},t("div",{style:{marginBottom:"20px",padding:"10px",background:"#e5e5e5",display:"flex",justifyContent:"space-between",alignItems:"center"}},t(a,{isSecondary:!0,onClick:()=>w(0)},"< Back to Structure"),t("h2",{style:{margin:0}},"Step 2: Template & Design"),t(a,{isPrimary:!0,isBusy:b,onClick:()=>$(!0)},b?"Building...":"Save & Build Block")),E&&t(o,{title:"Template Snippets (Use these keys in your HTML)",initialOpen:!0,style:{marginBottom:"20px",background:"#f0f6fc",border:"1px solid #cce5ff"}},t("div",{dangerouslySetInnerHTML:{__html:E},style:{fontSize:"13px",lineHeight:"1.6",maxHeight:"250px",overflowY:"auto",padding:"10px"}})),t("div",{style:{display:"flex",gap:"20px"}},t("div",{style:{width:"50%"}},t("h3",null,"HTML Template"),t("p",{style:{fontSize:"12px",color:"#666"}},"Use Mustache syntax {{key}} for dynamic data."),t("textarea",{id:"bf-html-template-area",value:x,onChange:e=>h(e.target.value),style:{width:"100%",minHeight:"400px",fontFamily:"monospace",padding:"12px",fontSize:"13px",border:"1px solid #757575",borderRadius:"4px",whiteSpace:"pre"},placeholder:`<div class="banner">\n  <h2>{{${u[0]?.key||"field_key"}}}</h2>\n</div>`})),t("div",{style:{width:"50%"}},t("h3",null,"CSS Styles"),t("p",{style:{fontSize:"12px",color:"#666"}},"Scoped automatically to the block wrapper."),t("textarea",{value:k,onChange:e=>S(e.target.value),style:{width:"100%",minHeight:"400px",fontFamily:"monospace",padding:"12px",fontSize:"13px",border:"1px solid #757575",borderRadius:"4px",whiteSpace:"pre"},placeholder:".bf-block-example {\n  background: #f0f0f0;\n  padding: 20px;\n}"}))),t("hr",{style:{margin:"20px 0"}}),m&&t("div",{style:{padding:"15px",backgroundColor:m.includes("✅")?"#d4edda":"#f8d7da",color:m.includes("✅")?"#155724":"#721c24",border:"1px solid",borderColor:m.includes("✅")?"#c3e6cb":"#f5c6cb",borderRadius:"4px",textAlign:"center",fontWeight:"bold"}},m)):null};jQuery(document).ready(function(){const e=document.getElementById("component-editor-root");e&&"undefined"!=typeof blockFactoryEditor&&wp.element.render(t(u,{initialConfig:blockFactoryEditor.config,blockSlug:blockFactoryEditor.blockSlug}),e)})})();