(()=>{const{useState:e,useEffect:l,createElement:a}=wp.element,{Button:t,TextControl:i,Panel:n,PanelBody:o,SelectControl:r}=wp.components,u=[{label:"Text Input",value:"text"},{label:"Number Input",value:"number"},{label:"Range Slider",value:"range"},{label:"URL Link",value:"url"},{label:"Text Area",value:"textarea"},{label:"Rich Text Content",value:"contentEditor"},{label:"Image/Media",value:"image"},{label:"File Upload",value:"file"},{label:"Gallery",value:"gallery"},{label:"Date Picker",value:"date"},{label:"Date Time Picker",value:"datetime"},{label:"Time Picker",value:"time"},{label:"Color Picker",value:"color"},{label:"Icon Picker",value:"icon"},{label:"Repeater/Group",value:"repeater"},{label:"Relational (Post Select)",value:"relational"}],d=e=>e.toLowerCase().replace(/[^a-z0-9_]/g,""),s=({initialConfig:l,blockSlug:s})=>{const[c,b]=e(l.fields||[]),[p,y]=e(!1),[g,f]=e(null),[m,v]=e(""),k=(e,l,a)=>{const t=c.map((t,i)=>i===e?("key"===l&&(a=a.toLowerCase().replace(/[^a-z0-9_]/g,"")),{...t,[l]:a}):t);b(t),f(t[e])},h=(e,l,n,s)=>{const c=e.subFields||[],b=(e,a,t)=>{const i=c.map((l,i)=>i===e?("key"===a&&(t=d(t)),{...l,[a]:t}):l);n(l,"subFields",i)};return a(o,{title:"Repeater Sub-Fields",initialOpen:!0},a("h4",null,"Add New Sub-Field"),a("div",{style:{display:"flex",flexWrap:"wrap",gap:"5px",marginBottom:"15px"}},u.filter(e=>"repeater"!==e.value&&"relational"!==e.value).map(e=>a(t,{isSecondary:!0,onClick:()=>(e=>{const a={type:e,key:d(`sub_field_${c.length}_${e}`),label:`New ${e} Sub-Field`,default:""};n(l,"subFields",[...c,a])})(e.value)},e.label))),a("h4",null,`Current Sub-Fields (${c.length})`),c.length>0?c.map((e,d)=>((e,d)=>a(o,{title:`${e.label} (${e.type})`,initialOpen:!1,key:d,className:"repeater-sub-field-settings"},a(i,{label:"Sub-Field Label",value:e.label,onChange:e=>b(d,"label",e)}),a(i,{label:"Attribute Key (Variable Name)",value:e.key,help:"Must be unique, lowercase, and contain only letters, numbers, and underscores.",onChange:e=>b(d,"key",e)}),a(r,{label:"Sub-Field Type",value:e.type,options:u.map(e=>({label:e.label,value:e.value})).filter(e=>"repeater"!==e.value),onChange:e=>b(d,"type",e)}),a(t,{isDestructive:!0,onClick:()=>(e=>{const a=c.filter((l,a)=>a!==e);n(l,"subFields",a)})(d),style:{marginTop:"10px"}},"Delete Sub-Field")))(e,d)):a("p",null,"No sub-fields defined. Add one above."))};return a("div",{style:{display:"flex",gap:"20px",marginTop:"20px"}},a("div",{style:{width:"20%",borderRight:"1px solid #ccc",paddingRight:"20px"}},a("h3",null,"Component Palette"),u.map(e=>a(t,{isSecondary:!0,style:{display:"block",width:"100%",marginBottom:"10px"},onClick:()=>(e=>{const l={type:e,key:`new_field_${c.length}`,label:`New ${e} Field`,default:""};b([...c,l]),f(l)})(e.value)},e.label))),a("div",{style:{width:"40%"}},a("h3",null,"Block Structure"),c.map((e,l)=>a("div",{key:l,style:{padding:"10px",marginBottom:"8px",border:"1px solid #ddd",backgroundColor:g===e?"#eaf4ff":"#fff",cursor:"pointer"},onClick:()=>f(e)},`${e.label} (${e.type})`)),a("hr",null),a(t,{isPrimary:!0,isBusy:p,onClick:()=>{y(!0),v("");const e={action:"block_factory_save_structure",nonce:blockFactoryEditorData.nonce,block_slug:s,config_data:JSON.stringify({fields:c})};jQuery.post(ajaxurl,e).done(e=>{e.success?v(`✅ Success! ${e.data.message} ${e.data.next_step}`):v(`❌ Error: ${e.data.message}`)}).fail(()=>{v("❌ Critical Error: Could not reach the server.")}).always(()=>{y(!1)})},disabled:p},p?"Saving...":"Save Structure & Regenerate Code"),m&&a("p",{style:{marginTop:"15px",fontWeight:"bold"}},m)),a("div",{style:{width:"40%"}},(()=>{if(!g)return a("p",null,"Select a field on the left to edit its properties.");const e=c.indexOf(g);return a(n,{header:"Field Settings"},a(o,{title:`Editing: ${g.label} (${g.type})`,initialOpen:!0},a(i,{label:"Field Label",value:g.label,onChange:l=>k(e,"label",l)}),a(i,{label:"Attribute Key (Variable Name)",value:g.key,help:"Must be unique, lowercase, and contain only letters, numbers, and underscores.",onChange:l=>k(e,"key",l)}),a(i,{label:"Default Value (Optional)",value:g.default,onChange:l=>k(e,"default",l)}),a(t,{isDestructive:!0,onClick:()=>(e=>{b(c.filter((l,a)=>a!==e)),f(null)})(e),style:{marginTop:"10px"}},"Delete Field")),"repeater"===g.type&&h(g,e,k))})()))};jQuery(document).ready(function(){const e=document.getElementById("component-editor-root");e&&"undefined"!=typeof blockFactoryEditorData&&wp.element.render(a(s,{initialConfig:blockFactoryEditorData.config,blockSlug:blockFactoryEditorData.blockSlug}),e)})})();