# Block Factory Plugin Documentation

## 1. Overview

**Block Factory** (built with GutenKit) is a WordPress plugin that allows developers to visually design and generate custom Gutenberg blocks. It handles the scaffolding, code generation, and build process, allowing for rapid block development without manual boilerplate coding.

## 2. Architecture & File Structure

The plugin follows an object-oriented architecture with a clear separation of concerns.

### Directory Structure

```
block-factory/
├── block-factory.php           # Entry point
├── includes/
│   ├── class-gutenkit-loader.php    # Bootstraps the plugin
│   ├── class-gutenkit-register.php  # Handles block registration
│   ├── class-gutenkit-generator.php # Generates block code & handles AJAX
│   └── class-gutenkit-admin.php     # Manages Admin UI
├── admin/
│   ├── component-editor.php    # HTML wrapper for the React editor
│   ├── generator-form.php      # Form to create a new block
│   └── js/editor-app.js        # React App for visual field editing
├── assets/                     # Static assets (CSS/JS)
├── blocks/                     # Generated block source code
├── build/                      # Compiled block attributes (generated by npm build)
└── templates/                  # Templates for block files (edit.js, block.json, etc.)
```

## 3. Data Flow & Lifecycle

### Step 1: Plugin Activation & Initialization

**File:** `block-factory.php` -> `includes/class-gutenkit-loader.php`

1.  **Entry:** `block-factory.php` instantiates `GutenKit_Loader`.
2.  **Loader:**
    - Defines constants (`BLOCK_FACTORY_PATH`, etc.).
    - Includes core classes.
    - **Hooks:**
      - Instantiates `GutenKit_Register` (hooks into `init`).
      - Instantiates `GutenKit_Generator` (hooks into `wp_ajax_...`).
      - Instantiates `GutenKit_Admin` (hooks into `admin_menu`).
3.  **Activation Hook:** Checks if `node_modules` exists. If not, it attempts to run `npm install` to set up build dependencies.

### Step 2: Admin Interface & Routing

**File:** `includes/class-gutenkit-admin.php`

1.  **Menu:** Adds "Block Factory" to the WP Admin menu.
2.  **Dashboard:** Lists existing blocks found in the `blocks/` directory.
3.  **Editor Router:**
    - Checks for `page=block-factory&action=edit_structure`.
    - Loads `admin/component-editor.php`.
    - Reads `blocks/{slug}/config.json` to load existing fields.
    - Enqueues `admin/js/editor-app.js` (React App) and passes data via `wp_localize_script`.

### Step 3: Visual Block Editing

**File:** `src/editor-app.js` (Compiled to `admin/js/editor-app.js`)

1.  **UI:** Provides a drag-and-drop interface to add/reorder fields (Text, Image, Repeater, etc.).
2.  **State:** Manages the block configuration in a JSON object structure.
3.  **Saving:**
    - Sends the JSON configuration to the backend via AJAX action `block_factory_save_structure`.

### Step 4: Code Generation (The Engine)

**File:** `includes/class-gutenkit-generator.php`

When `block_factory_save_structure` involves:

1.  **Save Config:** Writes the received JSON to `blocks/{slug}/config.json`.
2.  **Update `block.json`:** Maps fields to Gutenberg attributes (e.g., `text` -> `string`, `repeater` -> `array`).
3.  **Regenerate `edit.js`:**
    - Reads `templates/edit.js.tpl`.
    - Generates React code for Inspector Controls (Sidebar) and Canvas preview.
    - Injects specific component imports (e.g., `RangeControl`, `MediaUpload`).
4.  **Generates `render.php`:** Creates the PHP file responsible for frontend rendering.

### Step 5: Building the Block

**Action:** `bf_run_npm_build` (AJAX)

1.  **Trigger:** User clicks "Build Block" in the admin.
2.  **Execution:** `handle_run_build` executes `npm run build` using the detected Node/NPM environment.
3.  **Outcome:** Webpack compiles `blocks/{slug}/index.js`, `edit.js`, `style.scss` into the `build/{slug}/` directory.

### Step 6: Block Registration & Rendering

**File:** `includes/class-gutenkit-register.php`

1.  **Init Hook:** Scans `build/` (prioritized) or `blocks/` directories.
2.  **Register:** Calls `register_block_type_from_metadata` for each found block.
3.  **Render Callback:** Point to `blocks/{slug}/render.php` to render the block content dynamically.

## 4. Key Features Implementation

### Repeater Fields

- **Editor:** Uses `draggedSubIndex` logic in `src/editor-app.js` to allow dragging sub-fields.
- **Generator:** `class-gutenkit-generator.php` has specific logic to Loop through sub-fields and generate nested JSX for the editor.
- **Frontend:** `render.php` template includes a PHP `foreach` loop to iterate over the array of data.

### Drag-and-Drop Reordering

- **Implementation:** Native HTML5 Drag and Drop API.
- **Logic:** `handleDragStart`, `handleDragEnter` (for live reordering), and `handleDrop` in `src/editor-app.js`.
- **State:** Temporarily reorders the `fields` array in React state during drag, committing it on drop.

## 5. Troubleshooting

- **"npm not found"**: The plugin attempts to auto-detect Node. If it fails, define `WP_BLOCK_FACTORY_NODE_PATH` in `wp-config.php`.
- **Missing Dependencies**: If `dependencies installed` fails, check file permissions or run `npm install` manually in the plugin directory.
- **Changes not showing**: Ensure you clicked "Build Block" after saving the structure. Gutenberg requires the build step to update the React code.
